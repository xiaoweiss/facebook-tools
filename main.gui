import tkinter as tk
from tkinter import ttk, messagebox
from threading import Thread
from main import main_operation, TaskType, APIClient
import sys
import platform
import time

class BillingGUI(tk.Tk):
    def __init__(self):
        super().__init__()
        self.title("Facebookè‡ªåŠ¨åŒ–å·¥å…·")
        self.geometry("800x600")
        self._configure_platform()
        self._init_components()
        self.auth_valid = False

    def _configure_platform(self):
        """å¹³å°å…¼å®¹æ€§é…ç½®"""
        if platform.system() == 'Windows':
            self._windows_config()
        elif platform.system() == 'Darwin':
            self._macos_config()

    def _windows_config(self):
        """Windowsä¸“ç”¨é…ç½®"""
        # é«˜DPIé€‚é…
        if sys.getwindowsversion().build >= 14393:
            from ctypes import windll
            windll.shcore.SetProcessDpiAwareness(1)
        
        # è®¾ç½®çª—å£å›¾æ ‡
        try:
            self.iconbitmap('app.ico')
        except Exception as e:
            print(f"å›¾æ ‡åŠ è½½å¤±è´¥: {str(e)}")
        
        # ä½¿ç”¨ç³»ç»Ÿä¸»é¢˜
        self.style = ttk.Style()
        self.style.theme_use('vista')

    def _macos_config(self):
        """macOSä¸“ç”¨é…ç½®"""
        # éšè—å¤šä½™èœå•é¡¹
        self.tk.call('tk', 'scaling', 2.0)
        self.tk.call('namespace', 'import', 'ttk::theme::aqua')

    def _init_components(self):
        main_frame = ttk.Frame(self, padding=20)
        main_frame.pack(expand=True, fill='both')

        # æˆæƒåŒº
        auth_frame = ttk.LabelFrame(main_frame, text="ç³»ç»Ÿæˆæƒ")
        auth_frame.pack(fill='x', pady=10)
        
        ttk.Label(auth_frame, text="æˆæƒè´¦å·:").grid(row=0, column=0, padx=5)
        self.auth_entry = ttk.Entry(auth_frame, width=30)
        self.auth_entry.grid(row=0, column=1, padx=5)
        
        self.auth_btn = ttk.Button(auth_frame, text="éªŒè¯æˆæƒ", command=self._start_auth)
        self.auth_btn.grid(row=0, column=2, padx=10)
        self.auth_status = ttk.Label(auth_frame, text="âŒ æœªæˆæƒ", foreground='red')
        self.auth_status.grid(row=0, column=3, padx=5)

        # ä»»åŠ¡åŒº
        task_frame = ttk.LabelFrame(main_frame, text="ä»»åŠ¡é€‰æ‹©")
        task_frame.pack(fill='x', pady=10)
        
        self.task_var = tk.IntVar(value=1)
        ttk.Radiobutton(task_frame, text="æŸ¥è¯¢ä½™é¢", variable=self.task_var,
                       value=TaskType.CHECK_BALANCE.value).pack(side=tk.LEFT, padx=20)
        ttk.Radiobutton(task_frame, text="åˆ›å»ºå¹¿å‘Š", variable=self.task_var,
                       value=TaskType.CREATE_AD.value).pack(side=tk.LEFT, padx=20)

        # æ–°å¢å®šæ—¶ä»»åŠ¡åŒº
        schedule_frame = ttk.LabelFrame(main_frame, text="å®šæ—¶è®¾ç½®")
        schedule_frame.pack(fill='x', pady=10)
        
        ttk.Label(schedule_frame, text="æ‰§è¡Œé¢‘ç‡:").grid(row=0, column=0)
        self.schedule_mode = ttk.Combobox(schedule_frame, values=["å•æ¬¡", "æ¯æ—¥", "æ¯å‘¨"], state="readonly")
        self.schedule_mode.grid(row=0, column=1)
        self.schedule_mode.current(0)
        
        ttk.Label(schedule_frame, text="é—´éš”å°æ—¶:").grid(row=0, column=2)
        self.interval = ttk.Spinbox(schedule_frame, from_=1, to=24, width=5)
        self.interval.grid(row=0, column=3)
        
        self.weekdays_var = tk.StringVar()
        weekdays_frame = ttk.Frame(schedule_frame)
        weekdays_frame.grid(row=1, column=0, columnspan=4, pady=5)
        for i, day in enumerate(["å‘¨ä¸€","å‘¨äºŒ","å‘¨ä¸‰","å‘¨å››","å‘¨äº”","å‘¨å…­","å‘¨æ—¥"]):
            cb = ttk.Checkbutton(weekdays_frame, text=day, variable=self.weekdays_var)
            cb.grid(row=0, column=i, padx=2)

        # æ“ä½œåŒº
        btn_frame = ttk.Frame(main_frame)
        btn_frame.pack(pady=15)
        
        self.start_btn = ttk.Button(btn_frame, text="å¼€å§‹æ‰§è¡Œ", state='disabled', command=self._start_task)
        self.start_btn.pack(side=tk.LEFT, padx=10)
        ttk.Button(btn_frame, text="é€€å‡º", command=self.destroy).pack(side=tk.RIGHT, padx=10)

        # æ—¥å¿—åŒº
        log_frame = ttk.LabelFrame(main_frame, text="æ‰§è¡Œæ—¥å¿—")
        log_frame.pack(expand=True, fill='both')
        
        self.log_area = tk.Text(log_frame, wrap=tk.WORD, state='disabled')
        scroll = ttk.Scrollbar(log_frame, command=self.log_area.yview)
        self.log_area.configure(yscrollcommand=scroll.set)
        
        scroll.pack(side=tk.RIGHT, fill='y')
        self.log_area.pack(expand=True, fill='both')

    def _start_auth(self):
        """å¯åŠ¨æˆæƒæµç¨‹"""
        username = self.auth_entry.get().strip()
        if not username:
            self._show_error("è¯·è¾“å…¥æˆæƒè´¦å·")
            return
        
        self.auth_btn.config(state='disabled', text="éªŒè¯ä¸­...")
        Thread(target=self._perform_auth, args=(username,), daemon=True).start()

    def _perform_auth(self, username):
        """å®Œå…¨å¤ç”¨main.pyçš„é‰´æƒæµç¨‹"""
        try:
            client = APIClient()
            while True:
                response = client.get_auth_token(username)
                
                if response and response.get('code') == 1:
                    self.after(0, self._update_auth_status, True, "âœ… æˆæƒæˆåŠŸ")
                    self.after(0, self.start_btn.config, {'state': 'normal'})
                    self._log(f"ç”¨æˆ· {username} æˆæƒé€šè¿‡")
                    break
                else:
                    self.after(0, self._show_error, "æˆæƒå¤±è´¥ï¼Œè¯·æ£€æŸ¥è´¦å·")
                    self.after(0, self.auth_entry.delete, 0, tk.END)
                    break
        except Exception as e:
            self._log(f"æˆæƒå¼‚å¸¸: {str(e)}", error=True)
        finally:
            self.after(0, self.auth_btn.config, {'state': 'normal', 'text': 'éªŒè¯æˆæƒ'})

    def _start_task(self):
        """è§£æå®šæ—¶å‚æ•°"""
        schedule_config = {
            'mode': self.schedule_mode.get(),
            'interval': int(self.interval.get()),
            'weekdays': self.weekdays_var.get().split()
        }
        Thread(target=self._schedule_runner, args=(schedule_config,)).start()

    def _schedule_runner(self, config):
        """å®šæ—¶ä»»åŠ¡æ‰§è¡Œå™¨"""
        from apscheduler.schedulers.background import BackgroundScheduler
        scheduler = BackgroundScheduler()
        
        if config['mode'] == 'æ¯æ—¥':
            scheduler.add_job(self._execute_task, 'interval', hours=config['interval'])
        elif config['mode'] == 'æ¯å‘¨':
            scheduler.add_job(self._execute_task, 'cron', day_of_week=','.join(config['weekdays']))
        else:
            self._execute_task()
            return
            
        scheduler.start()
        try:
            while True: 
                time.sleep(1)
        except (KeyboardInterrupt, SystemExit):
            scheduler.shutdown()

    def _execute_task(self, username, task_type):
        """æ‰§è¡Œä¸»ä»»åŠ¡ï¼ˆä¿æŒåŸæœ‰é€»è¾‘ï¼‰"""
        try:
            self._log(f"ğŸš€ å¼€å§‹æ‰§è¡Œä»»åŠ¡ | ç”¨æˆ·: {username} | ç±»å‹: {TaskType(task_type).name}")
            main_operation(TaskType(task_type), username)
            self._log("âœ… ä»»åŠ¡æ‰§è¡Œå®Œæˆ")
        except Exception as e:
            self._log(f"âŒ æ‰§è¡Œå¤±è´¥: {str(e)}", error=True)
        finally:
            self.after(0, self.start_btn.config, {'state': 'normal', 'text': 'å¼€å§‹æ‰§è¡Œ'})

    def _update_auth_status(self, success, message):
        """æ›´æ–°æˆæƒçŠ¶æ€"""
        color = 'green' if success else 'red'
        self.auth_status.config(text=message, foreground=color)
        self.auth_valid = success

    def _log(self, message, error=False):
        """è®°å½•æ—¥å¿—"""
        self.log_area.config(state='normal')
        self.log_area.insert(tk.END, message + "\n")
        if error:
            self.log_area.tag_add('error', 'end-1c linestart', 'end-1c lineend')
            self.log_area.tag_config('error', foreground='red')
        self.log_area.see(tk.END)
        self.log_area.config(state='disabled')

    def _show_error(self, message):
        """æ˜¾ç¤ºé”™è¯¯æç¤º"""
        messagebox.showerror("é”™è¯¯", message)

if __name__ == "__main__":
    app = BillingGUI()
    app.mainloop() 